<!DOCTYPE html>
<html lang="es-ES">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Correo Ovh | Blog</title>
  <meta name="description" content="En esta página estatica vamos a guardar algunos de los trabajos que vaya realizando a lo largo del curso de 2ºASIR en el instituto I.E.S. Gonzalo Nazareno.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Correo Ovh" />
<meta property="og:description" content="Práctica: Servidor de correos Instala y configura de manera adecuada el servidor de correos en tu máquina de OVH, para tu dominio iesgnXX.es. El nombre del servidor de correo será mail.iesgnXX.es (Este es el nombre que deberá aparecer en el registro MX)
Para ello debemos de añadir un nuevo resgistro MX en nuestro dns de OVH por lo que debemos de dirigirnos a nuestro panel de control del DNS de nuestro OVH y tenemos que añadir una entrada como la siguiente:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://franjavimn.onrender.com/servicios/correo-ovh/" /><meta property="article:section" content="Servicios" />
<meta property="article:published_time" content="2021-02-11T12:32:11+01:00" />
<meta property="article:modified_time" content="2021-02-11T12:32:11+01:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Correo Ovh"/>
<meta name="twitter:description" content="Práctica: Servidor de correos Instala y configura de manera adecuada el servidor de correos en tu máquina de OVH, para tu dominio iesgnXX.es. El nombre del servidor de correo será mail.iesgnXX.es (Este es el nombre que deberá aparecer en el registro MX)
Para ello debemos de añadir un nuevo resgistro MX en nuestro dns de OVH por lo que debemos de dirigirnos a nuestro panel de control del DNS de nuestro OVH y tenemos que añadir una entrada como la siguiente:"/>

  
  
    
  
  
  <link rel="stylesheet" href="https://franjavimn.onrender.com/css/style-light.css">
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://franjavimn.onrender.com/images/favicon.ico" />

  
</head>
<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://franjavimn.onrender.com">
  
    <div id="logo" style="background-image: url(https://franjavimn.onrender.com/images/logo.png)"></div>
  
  <div id="title">
    <h1>Blog</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/sistemas">Sistemas</a></li>
       
        <li><a href="/seguridad">Seguridad</a></li>
       
        <li><a href="/servicios">Servicios</a></li>
       
        <li><a href="/implantacion">Implantacion</a></li>
       
        <li><a href="/bbdd">BBDD</a></li>
       
        <li><a href="/hlc">HLC</a></li>
       
        <li><a href="/proyecto-podman">Proyecto Podman</a></li>
      
    </ul>
  </div>
</header>
  

    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <h1 id="práctica-servidor-de-correos">Práctica: Servidor de correos</h1>
<p>Instala y configura de manera adecuada el servidor de correos en tu máquina de OVH, para tu dominio iesgnXX.es. El nombre del servidor de correo será mail.iesgnXX.es (Este es el nombre que deberá aparecer en el registro MX)</p>
<p>Para ello debemos de añadir un nuevo resgistro MX en nuestro dns de <strong>OVH</strong> por lo que debemos de dirigirnos a nuestro panel de control del DNS de nuestro OVH y tenemos que añadir una entrada como la siguiente:</p>
<ol>
<li>Primero una entrada CNAME que apunte a nuestro servidor, en mi casi lo vamos a llamar <strong>mail.iesgn13.es</strong> y va a apuntar a nuestra maquina <strong>omega.iesgn13.es</strong></li>
</ol>
<p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Servicios/mail-ovh/CNAME-mail-ovh.png" alt="CNAME mail OVH"></p>
<ol start="2">
<li>Una vez tengamos nuestro CNAME configurado, vamos a añadir el registro <strong>MX</strong> a nuestro DNS de ovh, para ello debemos de tenerlo de la siguiente manera:</li>
</ol>
<p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Servicios/mail-ovh/MX-mail-ovh.png" alt="MX mail OVH"></p>
<ol start="3">
<li>Una vez lo tengamos, necesitamos configurar una entrada para el protocolo <strong>SPF</strong> pero antes de hacerlo vamos a ver que es.
<strong>SPF</strong> es una protección contra la falsificación de direcciones en el envío de correo electrónico. Identifica, a través de los registros de nombres de dominio (DNS), a los servidores de correo SMTP autorizados para el transporte de los mensajes. Este convenio busca ayudar para disminuir abusos como el spam y otros males del correo electrónico. Una vez tengamos ya un concepto de lo que es y para que se usa el protocolo <strong>SPF</strong>, vamos a añadirle a nuestro DNS de OVH y tenemos que añadir un registro como el siguiente:</li>
</ol>
<p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Servicios/mail-ovh/SPF-mail-ovh-1.png" alt="SPF mail OVH"></p>
<p>Y a continuacion podemos poner mas datos, aunque este paso no es necesario ya que el registro ya apunta a una direccion ip y nosotros la estamos volviendio a poner:</p>
<p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Servicios/mail-ovh/SPF-mail-ovh-2.png" alt="SPF mail ovh no"></p>
<h1 id="gestión-de-correos-desde-el-servidor">Gestión de correos desde el servidor</h1>
<h2 id="tarea-1">Tarea 1</h2>
<p>Documenta una prueba de funcionamiento, donde envíes desde tu servidor local al exterior. Muestra el log donde se vea el envío. Muestra el correo que has recibido. Muestra el registro SPF.</p>
<p>Para ello, en nuestra maquina de OVH debemos de instalar el servidor de correos <strong>Postfix</strong> en nuestro servidor, para ello debemos de instalar el paquete llamado <strong>postfix</strong> por lo que lo instalamos junto a la herramienta llamada <strong>bsd-mailx</strong> que es un paquete con algunas utilidades para los correos electronicos.
Una vez instalado solo debemos de seguir los pasos que nos pide y poner en nuestro dominio que es <strong>iesgn13.es</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Instalamos postfix y bsd-mailx ####</span>
debian@omega:~$ sudo apt install postfix bsd-mailx -y

<span style="color:#75715e">#### El nombre de dominio debe de ser iesgnXX.es ####</span>
iesgn13.es

<span style="color:#75715e">#### Para ver nuestro nombre de dominio que tiene postfix vemos el fichero en /etc/mailname ####</span>
debian@omega:~$ cat /etc/mailname 
iesgn13.es
</code></pre></div><p>Ahora que lo tenemos, vamos a hacer una prueba de funcionamiento donde enviemos al exterior un correo, en mi caso me lo voy a mandar a mi mismo, para ello usamos la utilidad llamada <strong>mail</strong> seguido de la direccion de correo electronico:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Mandamos el correo ####</span>
debian@omega:~$ mail franjaviermn17100@gmail.com
Subject: Hola
Como estas?
Cc: 

<span style="color:#75715e">#### Vemos el log para ver que se ha enviado bien ####</span>
...
Jan <span style="color:#ae81ff">26</span> 10:41:34 omega postfix/smtp<span style="color:#f92672">[</span>15270<span style="color:#f92672">]</span>: 3120A82629: to<span style="color:#f92672">=</span>&lt;franjaviermn17100@gmail.com&gt;, relay<span style="color:#f92672">=</span>gmail-smtp-in.l.google.com<span style="color:#f92672">[</span>64.233.167.26<span style="color:#f92672">]</span>:25, delay<span style="color:#f92672">=</span>0.8, delays<span style="color:#f92672">=</span>0.02/0.01/0.49/0.27, dsn<span style="color:#f92672">=</span>2.0.0, status<span style="color:#f92672">=</span>sent <span style="color:#f92672">(</span><span style="color:#ae81ff">250</span> 2.0.0 OK  <span style="color:#ae81ff">1611657694</span> b4si17228448wri.94 - gsmtp<span style="color:#f92672">)</span>
...
</code></pre></div><p>Y en nuestro correo tendremos el mensaje que hemos enviado en nuestra bandeja de entrada:</p>
<p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Servicios/mail-ovh/mensaje-mail-iesgn13.png" alt="mensaje ovh"></p>
<p>Y si le damos a ver el mensaje original, veremos que tendremos mas informacion del mensaje y podremos ver como el protocolo <strong>SPF</strong> lo ha pasado sin problemas:</p>
<p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Servicios/mail-ovh/spf-pass.png" alt="spf pass"></p>
<h2 id="tarea-2">Tarea 2</h2>
<p>Documenta una prueba de funcionamiento, donde envíes un correo desde el exterior (gmail, hotmail,…) a tu servidor local. Muestra el log donde se vea el envío. Muestra cómo has leído el correo. Muestra el registro MX de tu dominio.</p>
<p>Para ello lo que vamos a hacer es contestar el correo que nos hemos enviado anteriormente para asi hacer la prueba de envio desde el exterior, para ello desde nuestra ventana de correo le respondemos con cualquier mensaje de hola y asi, cuando vayamos a nuestra maquina de ovh tendremos que ver si nos ha llegado el mensaje, para ello usamos la utilidad <strong>mail</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Despues de haber respondido el mensaje usamos mail en nuestra maquina ####</span>
You have new mail in /var/mail/debian
debian@omega:~$ mail
Mail version 8.1.2 01/15/2001.  Type ? <span style="color:#66d9ef">for</span> help.
 N  <span style="color:#ae81ff">2</span> franjaviermn17100  Tue Jan <span style="color:#ae81ff">26</span> 10:51   71/3425  Re: Hola
&amp; <span style="color:#ae81ff">2</span>

<span style="color:#75715e">#### Seleccionamos el mensaje 2 y nos aparecera toda la informacion y el mensaje en si ####</span>
Message 2:
From franjaviermn17100@gmail.com  Tue Jan <span style="color:#ae81ff">26</span> 10:51:35 <span style="color:#ae81ff">2021</span>
X-Original-To: debian@iesgn13.es
...
References: &lt;20210126104134.3120A82629@omega.iesgn13.es&gt;
In-Reply-To: &lt;20210126104134.3120A82629@omega.iesgn13.es&gt;
From: <span style="color:#f92672">=</span>?UTF-8?Q?Francisco_Javier_Martin_Nu<span style="color:#f92672">=</span>C3<span style="color:#f92672">=</span>B1ez?<span style="color:#f92672">=</span> &lt;franjaviermn17100@gmail.com&gt;
Date: Tue, <span style="color:#ae81ff">26</span> Jan <span style="color:#ae81ff">2021</span> 11:51:23 +0100
Subject: Re: Hola
To: Debian &lt;debian@iesgn13.es&gt;
Content-Type: multipart/alternative; boundary<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;00000000000031b26c05b9cb7099&#34;</span>

--00000000000031b26c05b9cb7099
Content-Type: text/plain; charset<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTF-8&#34;</span>
Content-Transfer-Encoding: quoted-printable

Estoy muy bien

El mar, <span style="color:#ae81ff">26</span> ene <span style="color:#ae81ff">2021</span> a las 11:41, Debian <span style="color:#f92672">(</span>&lt;debian@iesgn13.es&gt;<span style="color:#f92672">)</span> escribi<span style="color:#f92672">=</span>C3<span style="color:#f92672">=</span>B3<span style="color:#f92672">=</span>
...

<span style="color:#75715e">#### Vemos el log y veremos los siguientes registros ####</span>
Jan <span style="color:#ae81ff">26</span> 10:51:35 omega postfix/smtpd<span style="color:#f92672">[</span>15401<span style="color:#f92672">]</span>: connect from mail-wr1-f54.google.com<span style="color:#f92672">[</span>209.85.221.54<span style="color:#f92672">]</span>
Jan <span style="color:#ae81ff">26</span> 10:51:35 omega postfix/smtpd<span style="color:#f92672">[</span>15401<span style="color:#f92672">]</span>: B9A2F82629: client<span style="color:#f92672">=</span>mail-wr1-f54.google.com<span style="color:#f92672">[</span>209.85.221.54<span style="color:#f92672">]</span>
Jan <span style="color:#ae81ff">26</span> 10:51:35 omega postfix/cleanup<span style="color:#f92672">[</span>15411<span style="color:#f92672">]</span>: B9A2F82629: message-id<span style="color:#f92672">=</span>&lt;CA+kZvsjEh-Wz7LrfpNFy9uV+_KoL+t2Wfi6unQN3FnqkURRBog@mail.gmail.com&gt;
Jan <span style="color:#ae81ff">26</span> 10:51:35 omega postfix/qmgr<span style="color:#f92672">[</span>10907<span style="color:#f92672">]</span>: B9A2F82629: from<span style="color:#f92672">=</span>&lt;franjaviermn17100@gmail.com&gt;, size<span style="color:#f92672">=</span>3323, nrcpt<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>queue active<span style="color:#f92672">)</span>
Jan <span style="color:#ae81ff">26</span> 10:51:35 omega postfix/local<span style="color:#f92672">[</span>15412<span style="color:#f92672">]</span>: B9A2F82629: to<span style="color:#f92672">=</span>&lt;debian@iesgn13.es&gt;, relay<span style="color:#f92672">=</span>local, delay<span style="color:#f92672">=</span>0.03, delays<span style="color:#f92672">=</span>0.02/0.01/0/0, dsn<span style="color:#f92672">=</span>2.0.0, status<span style="color:#f92672">=</span>sent <span style="color:#f92672">(</span>delivered to mailbox<span style="color:#f92672">)</span>
</code></pre></div><h1 id="uso-de-alias-y-redirecciones">Uso de alias y redirecciones</h1>
<h2 id="tarea-3">Tarea 3</h2>
<p>Vamos a comprobar como los procesos del servidor pueden mandar correos para informar sobre su estado. Por ejemplo cada vez que se ejecuta una tarea cron podemos enviar un correo informando del resultado. Normalmente estos correos se mandan al usuario root del servidor, para ello:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Entramos en el usuario root ####</span>
debian@omega:~$ sudo su -

<span style="color:#75715e">#### Vamos a asignar el correo a root ####</span>
root@omega:~# crontab -e

MAILTO <span style="color:#f92672">=</span> root
</code></pre></div><p>Asi, cuando una accion del cron se ejecute en nuestro sistema debe de llegar a nuestro usuario <strong>root</strong> un correo informando de que se ha realizado una accion en el cron. Para ell vamos a crear un nuevo cron con el que vamos a ver si nos manda el correo a nuestro usuario root, para ello vamos a añadir la siguiente tarea cron a nuestro crontab:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Entramos en nuestro crontab ####</span>
root@omega:~# crontab -e

<span style="color:#75715e">#### Añadimos la siguiente linea ####</span>
<span style="color:#ae81ff">20</span> <span style="color:#ae81ff">11</span> * * * apt -y update
</code></pre></div><p>La nueva tarea cron que hemos añadido hara una actualizacion de la lista de paquetes de nuetra maquina todos los dias a las 12:10am, asi que, cuando se cumpla veremos que nos debe de llegar a nuestro usuario root un mensaje de correos diciendo que se ha realizado el cron:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Entramos en nuestro usuario root y vemos los mensajes ####</span>
root@omega:~# mail
Mail version 8.1.2 01/15/2001.  Type ? <span style="color:#66d9ef">for</span> help.
<span style="color:#e6db74">&#34;/var/mail/root&#34;</span>: <span style="color:#ae81ff">1</span> message <span style="color:#ae81ff">1</span> new
&gt;N  <span style="color:#ae81ff">1</span> root@iesgn13.es    Tue Jan <span style="color:#ae81ff">26</span> 11:20   31/1045  Cron &lt;root@omega&gt; apt -y update

<span style="color:#75715e">#### Lo abrimos y vemos que es la actualizacion ####</span>
Message 1:
From root@iesgn13.es  Tue Jan <span style="color:#ae81ff">26</span> 11:20:02 <span style="color:#ae81ff">2021</span>
X-Original-To: root
From: root@iesgn13.es <span style="color:#f92672">(</span>Cron Daemon<span style="color:#f92672">)</span>
To: root@iesgn13.es
Subject: Cron &lt;root@omega&gt; apt -y update
MIME-Version: 1.0
Content-Type: text/plain; charset<span style="color:#f92672">=</span>UTF-8
Content-Transfer-Encoding: 8bit
X-Cron-Env: &lt;MAILTO<span style="color:#f92672">=</span>root&gt;
X-Cron-Env: &lt;SHELL<span style="color:#f92672">=</span>/bin/sh&gt;
X-Cron-Env: &lt;HOME<span style="color:#f92672">=</span>/root&gt;
X-Cron-Env: &lt;PATH<span style="color:#f92672">=</span>/usr/bin:/bin&gt;
X-Cron-Env: &lt;LOGNAME<span style="color:#f92672">=</span>root&gt;
Date: Tue, <span style="color:#ae81ff">26</span> Jan <span style="color:#ae81ff">2021</span> 11:20:02 +0000 <span style="color:#f92672">(</span>UTC<span style="color:#f92672">)</span>


WARNING: apt does not have a stable CLI interface. Use with caution in scripts.

Hit:1 http://security.debian.org/debian-security buster/updates InRelease
Hit:2 http://deb.debian.org/debian buster InRelease
Hit:3 http://deb.debian.org/debian buster-updates InRelease
Reading package lists...
Building dependency tree...
Reading state information...
All packages are up to date.
</code></pre></div><p>Ahora vamos que vemos que lo envia al usuario root, vamos a hacer que nos lo envie a nuestro correo de gmail, para ello debemos de crear un alias hacia nuestro correo electronico pero, ¿qué es un alias en correo electronico?.</p>
<p>Cuando se define un alias para un determinado usuario se redirige el correo que llegue a otro usuario de la misma máquina. Los alias de correo se utilizan principalmente para gestionar el correo de las “cuentas de administración” y se definen en el fichero <strong>/etc/aliases</strong>. En dicho fichero vemos que los correos llegan a las cuentas de root generalmente, pero queremos que lo que llegue a root nos llegue a nuestro usuario real llamado <strong>fran</strong>, para ello debemos de tener el siguiente contenido:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Contenido del fichero aliases ####</span>
postmaster:    root
root: fran

<span style="color:#75715e">#### Una vez modificado usamos la opcion newaliases ####</span>
debian@omega:~$ sudo newaliases
</code></pre></div><p>Y vamos a comprobar con el cron que de verdad nos llegan los correos al usuario fran, para ello modificamos el cron y lo ponemos a otra hora:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Modificamos el cron ####</span>
<span style="color:#ae81ff">35</span> <span style="color:#ae81ff">11</span> * * * apt -y update
</code></pre></div><p>Y ahora esperamos a que nos llegue el correo una vez llegue la hora que le hemos indicado.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">fran@omega:~$ mail
Mail version 8.1.2 01/15/2001.  Type ? <span style="color:#66d9ef">for</span> help.
<span style="color:#e6db74">&#34;/var/mail/fran&#34;</span>: <span style="color:#ae81ff">1</span> message <span style="color:#ae81ff">1</span> new
&gt;N  <span style="color:#ae81ff">1</span> root@iesgn13.es    Tue Jan <span style="color:#ae81ff">26</span> 11:35   31/1045  Cron &lt;root@omega&gt; apt -y update
&amp; 
</code></pre></div><p>Y como vemos nos ha llegado de forma correcta, ahora debemos de conseguir que nos llegue a nuestro correo electronico de gmal, para ello lo que debemos de hacer es una <strong>redireccion</strong> para que los correos que llegue a ese usuario los envie a nuestro correo, para ello debemos de crear un fichero llamado <strong>.forward</strong> en la carpeta home del usuario en cuestión, en este caso en <strong>fran</strong> con el correo electronio en su interior o una lista de correos y, al realizarse una tarea cron nos debe de llegar un correo a nuestro correo de gmail:</p>
<p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Servicios/mail-ovh/correo%20cron.png" alt="correo gmail cron"></p>
<h1 id="para-luchar-contra-el-spam">Para luchar contra el SPAM</h1>
<h2 id="tarea-5">Tarea 5</h2>
<p>Configura de manera adecuada Postfix para que tenga en cuenta el registro SPF de los correos que recibe. Muestra el log del correo para comprobar que se está haciendo el testeo del registro SPF.</p>
<p>Para ello debemos de hacer que nuestro correo verifique los correos que llegue a nuestra maquina, para ello vamos a necesitar un paquete adicional llamado <strong>postfix-policyd-spf-python</strong> el cual vamos a instalar en nuestra maquina con su correo postfix. Cuando lo instalemos debemos de indicar en el fichero <strong>/etc/postfix/master.cf</strong> que cree un socket UNIX para la comprobación:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Instalamos el paquete necesario ####</span>
debian@omega:~$ sudo apt install postfix-policyd-spf-python

<span style="color:#75715e">#### Añadimos la siguiente linea en el fichero /etc/postfix/master.cf ####</span>
policyd-spf  unix  -       n       n       -       <span style="color:#ae81ff">0</span>       spawn     user<span style="color:#f92672">=</span>policyd-spf argv<span style="color:#f92672">=</span>/usr/bin/policyd-spf
</code></pre></div><p>Ahora debemos de indicar en el fichero <strong>/etc/postfix/main.cf</strong> que haga la comprobación en ese socke unix, por lo que debemos de añadir las siguientes lineas:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Modificamos el fichero /etc/postfix/main.cf ####</span>
policyd-spf_time_limit <span style="color:#f92672">=</span> <span style="color:#ae81ff">3600</span>
smtpd_recipient_restrictions <span style="color:#f92672">=</span> check_policy_service unix:private/policyd-spf
</code></pre></div><p>Ahora vamos a reiniciar el servicios de postfix y vamos a enviar un correo a nuestro servidor para ver si hace la comprobacion spf:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Miramos en el log de /var/log/mail.log ####</span>
Jan <span style="color:#ae81ff">26</span> 17:09:35 omega postfix/smtpd<span style="color:#f92672">[</span>22650<span style="color:#f92672">]</span>: connect from mail-wr1-f42.google.com<span style="color:#f92672">[</span>209.85.221.42<span style="color:#f92672">]</span>
Jan <span style="color:#ae81ff">26</span> 17:09:35 omega policyd-spf<span style="color:#f92672">[</span>22657<span style="color:#f92672">]</span>: prepend Received-SPF: Pass <span style="color:#f92672">(</span>mailfrom<span style="color:#f92672">)</span> identity<span style="color:#f92672">=</span>mailfrom; client-ip<span style="color:#f92672">=</span>209.85.221.42; helo<span style="color:#f92672">=</span>mail-wr1-f42.google.com; envelope-from<span style="color:#f92672">=</span>franjaviermn17100@gmail.com; receiver<span style="color:#f92672">=</span>&lt;UNKNOWN&gt; 
Jan <span style="color:#ae81ff">26</span> 17:09:35 omega postfix/smtpd<span style="color:#f92672">[</span>22650<span style="color:#f92672">]</span>: 9138A82630: client<span style="color:#f92672">=</span>mail-wr1-f42.google.com<span style="color:#f92672">[</span>209.85.221.42<span style="color:#f92672">]</span>
Jan <span style="color:#ae81ff">26</span> 17:09:35 omega postfix/cleanup<span style="color:#f92672">[</span>22660<span style="color:#f92672">]</span>: 9138A82630: message-id<span style="color:#f92672">=</span>&lt;CA+kZvsieXaGEX86PzAuFN5XDq1fbUfmZHH0-Km<span style="color:#f92672">=</span>Z+1dZt60HXw@mail.gmail.com&gt;
Jan <span style="color:#ae81ff">26</span> 17:09:35 omega postfix/qmgr<span style="color:#f92672">[</span>22592<span style="color:#f92672">]</span>: 9138A82630: from<span style="color:#f92672">=</span>&lt;franjaviermn17100@gmail.com&gt;, size<span style="color:#f92672">=</span>3496, nrcpt<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>queue active<span style="color:#f92672">)</span>
Jan <span style="color:#ae81ff">26</span> 17:09:35 omega postfix/local<span style="color:#f92672">[</span>22661<span style="color:#f92672">]</span>: 9138A82630: to<span style="color:#f92672">=</span>&lt;debian@iesgn13.es&gt;, relay<span style="color:#f92672">=</span>local, delay<span style="color:#f92672">=</span>0.32, delays<span style="color:#f92672">=</span>0.31/0.01/0/0, dsn<span style="color:#f92672">=</span>2.0.0, status<span style="color:#f92672">=</span>sent <span style="color:#f92672">(</span>delivered to mailbox<span style="color:#f92672">)</span>
Jan <span style="color:#ae81ff">26</span> 17:09:35 omega postfix/qmgr<span style="color:#f92672">[</span>22592<span style="color:#f92672">]</span>: 9138A82630: removed
Jan <span style="color:#ae81ff">26</span> 17:09:35 omega postfix/smtpd<span style="color:#f92672">[</span>22650<span style="color:#f92672">]</span>: disconnect from mail-wr1-f42.google.com<span style="color:#f92672">[</span>209.85.221.42<span style="color:#f92672">]</span> ehlo<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> starttls<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> mail<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> rcpt<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> bdat<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> quit<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> commands<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>
</code></pre></div><p>Ya tenemos el verificador de spf en nuestro servidor de correos postfix configurado.</p>
<h2 id="tarea-6">Tarea 6</h2>
<p>Configura un sistema antispam. Realiza comprobaciones para comprobarlo.</p>
<p>Para ello vamos a instalar el sistema antispam llamado <strong>SpamAssassin</strong> por lo que debemos de instalar los paquetes <strong>spamassassin</strong> y <strong>spamc</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Instalamos los paquetes necesarios ####</span>
debian@omega:~$ sudo apt install spamc spamassassin
</code></pre></div><p>Una vez instalados los paquetes que necesitamos tenemos que añadir las siguientes lineas en el fichero <strong>/etc/postfix/master.cf</strong> que iremos añadiendo poco a poco:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Añadimos la siguiente linea para que queda algo como lo siguiente ####</span>
smtp      inet  n       -       y       -       -       smtpd
-o content_filter<span style="color:#f92672">=</span>spamassassin

<span style="color:#75715e">#### Añadimos esta linea quedanos algo parecido a lo siguiente ####</span>
submission inet n       -       y       -       -       smtpd
-o content_filter<span style="color:#f92672">=</span>spamassassin

<span style="color:#75715e">#### Al final del fichero debemos de añadir la siguiente linea ####</span>
spamassassin unix -     n       n       -       -       pipe
  user<span style="color:#f92672">=</span>debian-spamd argv<span style="color:#f92672">=</span>/usr/bin/spamc -f -e /usr/sbin/sendmail -oi -f <span style="color:#e6db74">${</span>sender<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>recipient<span style="color:#e6db74">}</span>
</code></pre></div><p>Una vez hayamos configurado el fichero <strong>/etc/postfix/master.cf</strong> debemos de reiniciar el servicio de postfix para ver si esta todo correcto, que deberia de estarlo.</p>
<p>Ahora vamos a pasar a la configuracion de <strong>Spamassassin</strong>, lo primero va a ser irnos al fichero <strong>/etc/spamassassin/local.cf</strong> y debemos de descomentar una linea como la siguiente:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Linea a descomentar ####</span>
rewrite_header Subject *****SPAM*****
</code></pre></div><p>Esto lo hacemos para que marque como SPAM los mensajes que lo sean. Y ahora vamos a habilitar y reiniciar los distintos servicios:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Reiniciamos el servicios de postfix ####</span>
debian@omega:~$ sudo systemctl restart postfix.service

<span style="color:#75715e">#### Habilitamos el servicio de spamassassin ####</span>
debian@omega:~$ sudo systemctl enable spamassassin.service

<span style="color:#75715e">#### Iniciamos el servicios de spamassassin ####</span>
debian@omega:~$ sudo systemctl start spamassassin.service
</code></pre></div><p>Y a la hora de enviar un mensaje con spam debe de salirnos los mensajes siguiente en el log de postfix:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Jan <span style="color:#ae81ff">26</span> 18:01:57 omega spamd<span style="color:#f92672">[</span>24888<span style="color:#f92672">]</span>: spamd: identified spam <span style="color:#f92672">(</span>999.9/5.0<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> debian-spamd:112 in 0.2 seconds, <span style="color:#ae81ff">3818</span> bytes.
Jan <span style="color:#ae81ff">26</span> 18:01:57 omega spamd<span style="color:#f92672">[</span>24888<span style="color:#f92672">]</span>: spamd: result: Y <span style="color:#ae81ff">999</span> - DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FROM,GTUBE,HTML_MESSAGE,RCVD_IN_MSPIKE_H2,SPF_PASS,URIBL_BLOCKED scantime<span style="color:#f92672">=</span>0.2,size<span style="color:#f92672">=</span>3818,user<span style="color:#f92672">=</span>debian-spamd,uid<span style="color:#f92672">=</span>112,required_score<span style="color:#f92672">=</span>5.0,rhost<span style="color:#f92672">=</span>::1,raddr<span style="color:#f92672">=</span>::1,rport<span style="color:#f92672">=</span>38494,mid<span style="color:#f92672">=</span>&lt;CA+kZvsg23JEMj32M6Frs1bc1UZ_2kSNeEpGKzP+wQ5wcdkQN-A@mail.gmail.com&gt;,autolearn<span style="color:#f92672">=</span>no autolearn_force<span style="color:#f92672">=</span>no
Jan <span style="color:#ae81ff">26</span> 18:01:57 omega postfix/pipe<span style="color:#f92672">[</span>25543<span style="color:#f92672">]</span>: B6A05826C7: to<span style="color:#f92672">=</span>&lt;debian@iesgn13.es&gt;, relay<span style="color:#f92672">=</span>spamassassin, delay<span style="color:#f92672">=</span>0.61, delays<span style="color:#f92672">=</span>0.32/0.01/0/0.29, dsn<span style="color:#f92672">=</span>2.0.0, status<span style="color:#f92672">=</span>sent <span style="color:#f92672">(</span>delivered via spamassassin service<span style="color:#f92672">)</span>
</code></pre></div><p>Asi, a la hora de ver nuestro correo lo veremos asi:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### vemos nuestro correo ####</span>
debian@omega:~$ mail
Mail version 8.1.2 01/15/2001.  Type ? <span style="color:#66d9ef">for</span> help.
<span style="color:#e6db74">&#34;/var/mail/debian&#34;</span>: <span style="color:#ae81ff">2</span> messages <span style="color:#ae81ff">1</span> new <span style="color:#ae81ff">2</span> unread
 U  <span style="color:#ae81ff">1</span> franjaviermn17100  Tue Jan <span style="color:#ae81ff">26</span> 17:55   79/4205  *****SPAM***** hola
&gt;N  <span style="color:#ae81ff">2</span> franjaviermn17100  Tue Jan <span style="color:#ae81ff">26</span> 18:01  102/5378  *****SPAM***** Fwd: hola
</code></pre></div><p>Vemos que tiene la cadena <em><strong><strong>SPAM</strong></strong></em> en el mensaje que el considera spam.</p>
<h2 id="tarea-7">Tarea 7</h2>
<p>Configura un sistema antivirus. Realiza comprobaciones para comprobarlo.</p>
<p>Para ell vamos a usar como sistema de antivirus llamado clamAV, para ello debemos de instalar los siguientes paquetes en nuestro sistema:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Instalamos los paquetes necesarios ####</span>
debian@omega:~$ sudo apt install clamav clamav-freshclam clamsmtp

<span style="color:#75715e">#### Reiniciamos el servicio llamado clamsmtp.service ####</span>
debian@omega:~$ sudo systemctl restart clamsmtp.service

<span style="color:#75715e">#### Reiniciamos el servicio de postfix ####</span>
debian@omega:~$ sudo systemctl restart postfix
</code></pre></div><p>Una vez hayamos hecho los pasos anteriores debemos de irnos al fichero de configuracion de <strong>/etc/clamsmtpd.conf</strong> y ahi debemos de buscar las lineas <strong>OutAddress:</strong> y la linea <strong>Listen:</strong> y debemos de dejarlo de la siguiente forma:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Fichero /etc/clamsmtpd.conf ####</span>
OutAddress: <span style="color:#ae81ff">10026</span>
...
Listen: 127.0.0.1:10025
</code></pre></div><p>Una vez hecho el anterior cambio debemos de irnos a nuestro fichero <strong>/etc/postfix/main.cf</strong> y vamos a añadir las siguientes lineas al final de este fichero:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Lineas a añadir ####</span>
content_filter <span style="color:#f92672">=</span> scan:127.0.0.1:10025
receive_override_options <span style="color:#f92672">=</span> no_address_mappings
</code></pre></div><p>Ahora nos dirigimos al fichero <strong>/etc/postfix/master.cf</strong> y debemos de añadir la lineas en la que le indicamos a nuestro servicio de correos donde debe de realizar la consulta sobre si es o no es un correo con algun virus, por lo que le vamos a añadir las siguientes lineas:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Añadimos las lineas siguientes a nuestro fichero ####</span>
scan      unix  -       -       n       -       <span style="color:#ae81ff">16</span>      smtp
        -o smtp_send_xforward_command<span style="color:#f92672">=</span>yes
...
127.0.0.1:10026      inet  n       -       n       -       <span style="color:#ae81ff">16</span>      smtpd
        -o content_filter<span style="color:#f92672">=</span>
        -o receive_override_options<span style="color:#f92672">=</span>no_unknown_recipient_checks,no_header_body_checks
        -o smtpd_helo_restrictions<span style="color:#f92672">=</span>
        -o smtpd_client_restrictions<span style="color:#f92672">=</span>
        -o smtpd_sender_restrictions<span style="color:#f92672">=</span>
        -o smtpd_recipient_restrictions<span style="color:#f92672">=</span>permit_mynetworks,reject
        -o mynetworks_style<span style="color:#f92672">=</span>host
        -o smtpd_authorized_xforward_hosts<span style="color:#f92672">=</span>127.0.0.0/8
</code></pre></div><p>Asi, al realizar la configuración vamos a reiniciar los servicios de <strong>clamsmtp.service</strong> y el servicio de <strong>postfix</strong> asi, ahora si recibimos un correo que nuestro antivirus detecte como un virus, lo descartará y no lo tendremos en nuestra bandeja de entrada. Para poder comprobar si funciona correctamente vamos a enviar un mensaje de prueba para ver si lo detecta como virus, para ello seguimos los pasos:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### En nuestro correo enviamos el siguiente mensaje ####</span>
X5O!P%@AP<span style="color:#f92672">[</span>4<span style="color:#ae81ff">\P</span>ZX54<span style="color:#f92672">(</span>P^<span style="color:#f92672">)</span>7CC<span style="color:#f92672">)</span>7<span style="color:#f92672">}</span>$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H* 

<span style="color:#75715e">#### Miramos los log de postfix para ver que hace con ese correo ####</span>
Jan <span style="color:#ae81ff">27</span> 17:45:32 omega postfix/smtpd<span style="color:#f92672">[</span>17782<span style="color:#f92672">]</span>: connect from mail-wr1-f42.google.com<span style="color:#f92672">[</span>209.85.221.42<span style="color:#f92672">]</span>
Jan <span style="color:#ae81ff">27</span> 17:45:32 omega policyd-spf<span style="color:#f92672">[</span>17789<span style="color:#f92672">]</span>: prepend Received-SPF: Pass <span style="color:#f92672">(</span>mailfrom<span style="color:#f92672">)</span> identity<span style="color:#f92672">=</span>mailfrom; client-ip<span style="color:#f92672">=</span>209.85.221.42; helo<span style="color:#f92672">=</span>mail-wr1-f42.google.com; envelope-from<span style="color:#f92672">=</span>franjaviermn17100@gmail.com; receiver<span style="color:#f92672">=</span>&lt;UNKNOWN&gt; 
...
Jan <span style="color:#ae81ff">27</span> 17:45:32 omega spamd<span style="color:#f92672">[</span>24888<span style="color:#f92672">]</span>: spamd: clean message <span style="color:#f92672">(</span>-0.1/5.0<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> debian-spamd:112 in 0.2 seconds, <span style="color:#ae81ff">2794</span> bytes.
Jan <span style="color:#ae81ff">27</span> 17:45:32 omega spamd<span style="color:#f92672">[</span>24888<span style="color:#f92672">]</span>: spamd: result: . <span style="color:#ae81ff">0</span> - DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FROM,HTML_MESSAGE,RCVD_IN_MSPIKE_H2,SPF_PASS,TVD_SPACE_RATIO scantime<span style="color:#f92672">=</span>0.2,size<span style="color:#f92672">=</span>2794,user<span style="color:#f92672">=</span>debian-spamd,uid<span style="color:#f92672">=</span>112,required_score<span style="color:#f92672">=</span>5.0,rhost<span style="color:#f92672">=</span>::1,raddr<span style="color:#f92672">=</span>::1,rport<span style="color:#f92672">=</span>38584,mid<span style="color:#f92672">=</span>&lt;CA+kZvsjbkMPbcUYhSfzzbGYCtVTZ07bVNT1+YvB<span style="color:#f92672">=</span>Ce2Ln9J_fQ@mail.gmail.com&gt;,autolearn<span style="color:#f92672">=</span>ham autolearn_force<span style="color:#f92672">=</span>no
Jan <span style="color:#ae81ff">27</span> 17:45:32 omega postfix/pipe<span style="color:#f92672">[</span>17795<span style="color:#f92672">]</span>: 9C5A0826CE: to<span style="color:#f92672">=</span>&lt;debian@iesgn13.es&gt;, relay<span style="color:#f92672">=</span>spamassassin, delay<span style="color:#f92672">=</span>0.51, delays<span style="color:#f92672">=</span>0.27/0.01/0/0.23, dsn<span style="color:#f92672">=</span>2.0.0, status<span style="color:#f92672">=</span>sent <span style="color:#f92672">(</span>delivered via spamassassin service<span style="color:#f92672">)</span>
Jan <span style="color:#ae81ff">27</span> 17:45:32 omega postfix/qmgr<span style="color:#f92672">[</span>17773<span style="color:#f92672">]</span>: 9C5A0826CE: removed
...
Jan <span style="color:#ae81ff">27</span> 17:45:32 omega clamsmtpd: 100002: accepted connection from: 127.0.0.1
Jan <span style="color:#ae81ff">27</span> 17:45:32 omega spamd<span style="color:#f92672">[</span>24887<span style="color:#f92672">]</span>: prefork: child states: II
Jan <span style="color:#ae81ff">27</span> 17:45:32 omega postfix/smtpd<span style="color:#f92672">[</span>17803<span style="color:#f92672">]</span>: connect from localhost<span style="color:#f92672">[</span>127.0.0.1<span style="color:#f92672">]</span>
Jan <span style="color:#ae81ff">27</span> 17:45:32 omega postfix/smtpd<span style="color:#f92672">[</span>17803<span style="color:#f92672">]</span>: ECB66826CE: client<span style="color:#f92672">=</span>localhost<span style="color:#f92672">[</span>127.0.0.1<span style="color:#f92672">]</span>
Jan <span style="color:#ae81ff">27</span> 17:45:32 omega postfix/smtp<span style="color:#f92672">[</span>17801<span style="color:#f92672">]</span>: D79E0826D0: to<span style="color:#f92672">=</span>&lt;debian@iesgn13.es&gt;, relay<span style="color:#f92672">=</span>127.0.0.1<span style="color:#f92672">[</span>127.0.0.1<span style="color:#f92672">]</span>:10025, delay<span style="color:#f92672">=</span>0.09, delays<span style="color:#f92672">=</span>0.01/0.02/0.07/0.01, dsn<span style="color:#f92672">=</span>2.0.0, status<span style="color:#f92672">=</span>sent <span style="color:#f92672">(</span><span style="color:#ae81ff">250</span> Virus Detected; Discarded Email<span style="color:#f92672">)</span>
Jan <span style="color:#ae81ff">27</span> 17:45:32 omega postfix/qmgr<span style="color:#f92672">[</span>17773<span style="color:#f92672">]</span>: D79E0826D0: removed
</code></pre></div><p>Y en este log podemos ver como entra en juego el servicio de <strong>spamassassin</strong> y detecta que no contiene spam, por lo que no lo marca como spam asi que pasa y entra en la comprobacion del antivirus <strong>clamAV</strong> y detecta que es un virus, por lo que lo descarta y no lo encontraremos en nuestra bandeja de correos en nuestro usuario.</p>
<h1 id="gestión-de-correos-desde-un-cliente">Gestión de correos desde un cliente</h1>
<h2 id="tarea-8">Tarea 8</h2>
<p>Configura el buzón de los usuarios de tipo Maildir. Envía un correo a tu usuario y comprueba que el correo se ha guardado en el buzón Maildir del usuario del sistema correspondiente. Recuerda que ese tipo de buzón no se puede leer con la utilidad mail.</p>
<p>Para ello debemos de configurar el buzon de correos Maildir, para ello debemos de irnos al fichero de configuración de nuestro postfix y ahi debemos de indicar la siguiente linea:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Añadimos la linea siguiente en /etc/postfix/main.cf #### </span>
home_mailbox <span style="color:#f92672">=</span> Maildir/
</code></pre></div><p>Asi reiniciamos el servicio y cuando nos llegue un correo veremos que se nos creara una carpeta en el usuario en cuestion llamada <strong>Maildir</strong> pero claro, ahora la utilidad de <strong>mail</strong> ya no nos funciona por lo que vamos a instalar ahora otro cliente, por ejemplo <strong>mutt</strong>, para ell seguimos los siguientes pasos:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Instalamos mutt ####</span>
debian@omega:~$ sudo apt install mutt

<span style="color:#75715e">#### Creamos en el directorio del usuario un fichero .muttrc ####</span>
debian@omega:~$ nano .muttrc

set mbox_type<span style="color:#f92672">=</span>Maildir
set folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;~/Maildir&#34;</span>
set mask<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;!^\\.[^.]&#34;</span>
set mbox<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;~/Maildir&#34;</span>
set record<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;+.Sent&#34;</span>
set postponed<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;+.Drafts&#34;</span>
set spoolfile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;~/Maildir&#34;</span>
</code></pre></div><p>De esta forma ya tendremos activado el nuevo cliente y con el fichero .muttrc le estamos diciendo al cliente donde debe de mirar los correos que lleguen y desde donde los debe de enviar, asi, si enviamos un correo de prueba debemos de verlo con solo poner en la terminal el comando <strong>mutt</strong>:</p>
<p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Servicios/mail-ovh/mutt-mensaje.png" alt="mutt mensaje"></p>
<p>Y si queremos enviar un mensaje desde nuestro nuevo cliente mutt, podemos usar la siguiente estructura:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">echo <span style="color:#e6db74">&#34;Cuerpo del mensaje&#34;</span> | mutt -s <span style="color:#e6db74">&#34;Titulo del mensaje&#34;</span> correo@destino.com
</code></pre></div><h2 id="tarea-9">Tarea 9</h2>
<p>Instala configura dovecot para ofrecer el protocolo IMAP. Configura dovecot de manera adecuada para ofrecer autentificación y cifrado.</p>
<p>Para realizar el cifrado de la comunicación crea un certificado en LetsEncrypt para el dominio mail.iesgnXX.es. En mi caso vamos a usar el protocolo <strong>IMAPS</strong> por lo que vamos a necesitar los certificados de letsEncrypt, para ello vamos a generarlos para el dominio mail.iesgn13.es por lo que vamos a necesitar seguir el tutorial de instalación del <a href="https://certbot.eff.org/">Certbot</a>.</p>
<p>Una vez instalado Certbot en nuestra maquina ejecutamos el siguiente comando para generar los certificados necesarios, debemos de tener en cuenta que si tenemos algun servidor web iniciado en la maquina debemos de parar el servicio para que certbot pueda realizar el challenge:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Generamos los certificados que necesitamos ####</span>
debian@omega:~$ sudo certbot certonly --standalone -d mail.iesgn13.es
</code></pre></div><p>Asi ya tendremos los certificados generados por lo que ya podemos seguir con la instalacion de <strong>dovecot</strong>, para ell debemos de instalar en nuestra maquina los paquetes llamados <strong>dovecot-imapd, dovecot-pop3d y dovecot-common</strong>. Una vez instalado debemos de configurarlos de la manera que vamos a mostrar a continuacion y le vamos a añadir el protocolo <strong>IMAPS</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Instalamos los paquetes necesarios ####</span>
debian@omega:~$ sudo apt install dovecot-imapd dovecot-pop3d dovecot-common

<span style="color:#75715e">#### Configuramos el fichero llamado /etc/dovecot/conf.d/10-auth.conf ####</span>
disable_plaintext_auth <span style="color:#f92672">=</span> no
...

<span style="color:#75715e">#### Aseguramos que las lineas esten de esta forma ####</span>
mail_location <span style="color:#f92672">=</span> maildir:~/Maildir
...
mail_privileged_group <span style="color:#f92672">=</span> mail
...
mail_access_groups <span style="color:#f92672">=</span> mail
</code></pre></div><p>Ahora lo que vamos a hacer es activar ssl en nuestro dovecot con el certificado que hemos generado con LetsEncrypt, para ello debemos de tener en cuenta que las rutas donde se encuentran la clave y el certificado estan en <strong>/etc/letsencrypt/live/{nuestro-dominio}</strong>. Asi nos vamos al fichero <strong>/etc/dovecot/conf.d/10-ssl.conf</strong> y ahi debemos de tener la siguiente configuracion:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Descomentamos las lineas siguientes ####</span>
ssl <span style="color:#f92672">=</span> yes
...
ssl_cert <span style="color:#f92672">=</span> &lt;/etc/letsencrypt/live/mail.iesgn13.es/fullchain.pem
ssl_key <span style="color:#f92672">=</span> &lt;/etc/letsencrypt/live/mail.iesgn13.es/privkey.pem

<span style="color:#75715e">#### Reiniciamos el servicio de dovecot ####</span>
sudo systemctl restart dovecot.service
</code></pre></div><p>Una vez lo tengamos, debemos de dirigirnos al fichero <strong>/etc/dovecot/conf.d/10-master.conf</strong> donde tenemos que descomentar las siguientes lineas para que asi podamos usar los puertos que usa el protocolo <strong>IMAPS</strong> por lo que debemos de tener los siguiente contenido:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Descomentamos las lineas sobre los protocoloes que necesitamos ####</span>
service imap-login <span style="color:#f92672">{</span>
  inet_listener imap <span style="color:#f92672">{</span>
    port <span style="color:#f92672">=</span> <span style="color:#ae81ff">143</span>
  <span style="color:#f92672">}</span>
  inet_listener imaps <span style="color:#f92672">{</span>
    port <span style="color:#f92672">=</span> <span style="color:#ae81ff">993</span>
    ssl <span style="color:#f92672">=</span> yes
  <span style="color:#f92672">}</span>
...
<span style="color:#75715e">#Postfix smtp-auth</span>
   unix_listener /var/spool/postfix/private/auth <span style="color:#f92672">{</span>
   mode <span style="color:#f92672">=</span> <span style="color:#ae81ff">0660</span>
   user <span style="color:#f92672">=</span> postfix
   group <span style="color:#f92672">=</span> postfix
  <span style="color:#f92672">}</span>

<span style="color:#75715e">#### Reiniciamos el servicios y vemos los puertos que tenemos abiertos ####</span>
debian@omega:~$ sudo ss -lnpt | grep <span style="color:#ae81ff">465</span>
LISTEN    <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">100</span>                0.0.0.0:465              0.0.0.0:*        users:<span style="color:#f92672">((</span><span style="color:#e6db74">&#34;master&#34;</span>,pid<span style="color:#f92672">=</span>5371,fd<span style="color:#f92672">=</span>22<span style="color:#f92672">))</span>                                              
LISTEN    <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">100</span>                   <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:465                 <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:*        users:<span style="color:#f92672">((</span><span style="color:#e6db74">&#34;master&#34;</span>,pid<span style="color:#f92672">=</span>5371,fd<span style="color:#f92672">=</span>23<span style="color:#f92672">))</span>  

debian@omega:~$ sudo ss -lnpt | grep <span style="color:#ae81ff">993</span>
LISTEN    <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">100</span>                0.0.0.0:993              0.0.0.0:*        users:<span style="color:#f92672">((</span><span style="color:#e6db74">&#34;dovecot&#34;</span>,pid<span style="color:#f92672">=</span>5377,fd<span style="color:#f92672">=</span>40<span style="color:#f92672">))</span>                                             
LISTEN    <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">100</span>                   <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:993                 <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:*        users:<span style="color:#f92672">((</span><span style="color:#e6db74">&#34;dovecot&#34;</span>,pid<span style="color:#f92672">=</span>5377,fd<span style="color:#f92672">=</span>41<span style="color:#f92672">))</span>
</code></pre></div><p>Asi, a la hora de entrar en nuestro cliente de correos remoto, como puede ser thunderbird, debemos de poner los siguientes elementos:</p>
<p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Servicios/mail-ovh/ssl-thunderbird.png" alt="ssl thunderbird"></p>
<p>Y a la hora de entrar en nuestro cliente veremos ya los correos de nuestro usuario:</p>
<p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Servicios/mail-ovh/recibido-thunderbird.png" alt="correos thunderbird"></p>
<h2 id="tarea-11">Tarea 11</h2>
<p>Configura de manera adecuada postfix para que podamos mandar un correo desde un cliente remoto. La conexión entre cliente y servidor debe estar autentificada con SASL usando dovecor y además debe estar cifrada. Para cifrar esta comunicación puedes usar dos opciones:</p>
<ul>
<li>
<p>ESMTP + STARTTLS: Usando el puerto 567/tcp enviamos de forma segura el correo al servidor.</p>
</li>
<li>
<p>SMTPS: Utiliza un puerto no estándar (465) para SMTPS (Simple Mail Transfer Protocol Secure). No es una extensión de smtp. Es muy parecido a HTTPS.</p>
</li>
</ul>
<p>Elige una de las opciones anterior para realizar el cifrado. Y muestra la configuración de un cliente de correo (evolution, thunderbird, …) y muestra como puedes enviar los correos.</p>
<p>En este caso nosotros vamos a usar la segunda opción que, como hemos visto en la anterior tarea, ya tenemos el puerto que necesita el protocolo <strong>SMTPS</strong> que es el puerto 465, asi solo debemos de añadir las siguientes lineas a nuestro fichero <strong>/etc/postfix/main.cf</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Lineas que debemos de añadir ####</span>
smtpd_sasl_type <span style="color:#f92672">=</span> dovecot
smtpd_sasl_path <span style="color:#f92672">=</span> private/auth
smtpd_sasl_local_domain <span style="color:#f92672">=</span>
smtpd_sasl_security_options <span style="color:#f92672">=</span> noanonymous
broken_sasl_auth_clients <span style="color:#f92672">=</span> yes
smtpd_sasl_auth_enable <span style="color:#f92672">=</span> yes
smtp_tls_security_level <span style="color:#f92672">=</span> may
smtpd_tls_security_level <span style="color:#f92672">=</span> may
smtp_tls_note_starttls_offer <span style="color:#f92672">=</span> yes
smtpd_tls_loglevel <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
smtpd_tls_received_header <span style="color:#f92672">=</span> yes
</code></pre></div><p>Una vez añadidas las lineas que hemos indicado debemos de dirigirnos al fichero <strong>/etc/postfix/master.cf</strong> donde tendremos que añadir las siguientes lineas o, si ya estan en ese fichero solo tendremos que descomentar las lineas:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Lineas a añadir en el fichero /etc/postfix/master.cf ####</span>
smtps     inet  n       -       y       -       -       smtpd
<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
  -o syslog_name<span style="color:#f92672">=</span>postfix/smtps
  -o smtpd_tls_wrappermode<span style="color:#f92672">=</span>yes
  -o smtpd_sasl_auth_enable<span style="color:#f92672">=</span>yes
  -o smtpd_reject_unlisted_recipient<span style="color:#f92672">=</span>no
  -o smtpd_client_restrictions<span style="color:#f92672">=</span>$mua_client_restrictions
  -o smtpd_helo_restrictions<span style="color:#f92672">=</span>$mua_helo_restrictions
  -o smtpd_sender_restrictions<span style="color:#f92672">=</span>$mua_sender_restrictions
  -o smtpd_recipient_restrictions<span style="color:#f92672">=</span>
  -o smtpd_relay_restrictions<span style="color:#f92672">=</span>permit_sasl_authenticated,reject
  -o milter_macro_daemon_name<span style="color:#f92672">=</span>ORIGINATING
</code></pre></div><p>Despues de ello, debemos de indicar donde tenemos los certificados que hemos generado anteriormente con Certbot, por lo que nos dirigimos al fichero <strong>/etc/postfix/main.cf</strong> donde tenedremos que indicar la ruta donde tenemos dichas claves:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">smtpd_tls_cert_file<span style="color:#f92672">=</span>/etc/letsencrypt/live/mail.iesgn13.es/fullchain.pem
smtpd_tls_key_file<span style="color:#f92672">=</span>/etc/letsencrypt/live/mail.iesgn13.es/privkey.pem

<span style="color:#75715e">#### Reiniciamos postfix ####</span>
debian@omega:~$ sudo systemctl restart postfix
</code></pre></div><p>Una vez lo tengamos, debemos de tener en nuestro cliente de correos, en el apartado de <strong>SMTP</strong> la opción de <strong>SMTPS</strong> junto al puerto <strong>465</strong>:</p>
<p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Servicios/mail-ovh/SMTPS-ovh.png" alt="puerto con SMTPS"></p>
<p>Y a continuación vamos a enviar un mensaje a nuestro correo personal, de la siguiente forma tendremos el siguiente contenido en el log de mail:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Feb <span style="color:#ae81ff">12</span> 13:12:39 omega postfix/smtp<span style="color:#f92672">[</span>12285<span style="color:#f92672">]</span>: DCE85812B0: to<span style="color:#f92672">=</span>&lt;franjaviermn17100@gmail.com&gt;, relay<span style="color:#f92672">=</span>127.0.0.1<span style="color:#f92672">[</span>127.0.0.1<span style="color:#f92672">]</span>:10025, delay<span style="color:#f92672">=</span>0.35, delays<span style="color:#f92672">=</span>0.21/0.01/0.06/0.07, dsn<span style="color:#f92672">=</span>2.0.0, status<span style="color:#f92672">=</span>sent <span style="color:#f92672">(</span><span style="color:#ae81ff">250</span> 2.0.0 Ok: queued as 1A66F812B1<span style="color:#f92672">)</span>
</code></pre></div><p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Servicios/mail-ovh/mensaje-enviado-ovh.png" alt="Mensaje enviado mediante thunderbird"></p>

  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  Francisco Javier Martín Núñez 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/sistemas">Sistemas</a></li>
         
        <li><a href="/seguridad">Seguridad</a></li>
         
        <li><a href="/servicios">Servicios</a></li>
         
        <li><a href="/implantacion">Implantacion</a></li>
         
        <li><a href="/bbdd">BBDD</a></li>
         
        <li><a href="/hlc">HLC</a></li>
         
        <li><a href="/proyecto-podman">Proyecto Podman</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
  
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>
