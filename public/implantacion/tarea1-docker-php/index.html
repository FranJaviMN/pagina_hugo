<!DOCTYPE html>
<html lang="es-ES">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Tarea1 Docker Php | Blog</title>
  <meta name="description" content="En esta página estatica vamos a guardar algunos de los trabajos que vaya realizando a lo largo del curso de 2ºASIR en el instituto I.E.S. Gonzalo Nazareno.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Tarea1 Docker Php" />
<meta property="og:description" content="Repositorio git: https://github.com/FranJaviMN/Docker-php/tree/main/Tarea%201
Tarea 1: Ejecución de una aplicación web PHP en docker   Queremos ejecutar en un contenedor docker la aplicación web escrita en PHP: bookMedik (https://github.com/evilnapsis/bookmedik).
  Es necesario tener un contenedor con mariadb donde vamos a crear la base de datos y los datos de la aplicación. El script para generar la base de datos y los registros lo encuentras en el repositorio y se llama schema." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://franjavimn.onrender.com/implantacion/tarea1-docker-php/" />
<meta property="article:published_time" content="2021-03-02T10:33:35+01:00" />
<meta property="article:modified_time" content="2021-03-02T10:33:35+01:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tarea1 Docker Php"/>
<meta name="twitter:description" content="Repositorio git: https://github.com/FranJaviMN/Docker-php/tree/main/Tarea%201
Tarea 1: Ejecución de una aplicación web PHP en docker   Queremos ejecutar en un contenedor docker la aplicación web escrita en PHP: bookMedik (https://github.com/evilnapsis/bookmedik).
  Es necesario tener un contenedor con mariadb donde vamos a crear la base de datos y los datos de la aplicación. El script para generar la base de datos y los registros lo encuentras en el repositorio y se llama schema."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://franjavimn.onrender.com/css/style-white.css">
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://franjavimn.onrender.com/images/favicon.ico" />

  
</head>
<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://franjavimn.onrender.com">
  
    <div id="logo" style="background-image: url(https://franjavimn.onrender.com/images/logo.png)"></div>
  
  <div id="title">
    <h1>Blog</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/sistemas">Sistemas</a></li>
       
        <li><a href="/seguridad">Seguridad</a></li>
       
        <li><a href="/servicios">Servicios</a></li>
       
        <li><a href="/implantacion">Implantacion</a></li>
       
        <li><a href="/bbdd">BBDD</a></li>
       
        <li><a href="/hlc">HLC</a></li>
       
        <li><a href="/cloud">Cloud</a></li>
      
    </ul>
  </div>
</header>
  

    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <p><strong>Repositorio git: <a href="https://github.com/FranJaviMN/Docker-php/tree/main/Tarea%201">https://github.com/FranJaviMN/Docker-php/tree/main/Tarea%201</a></strong></p>
<h1 id="tarea-1-ejecución-de-una-aplicación-web-php-en-docker">Tarea 1: Ejecución de una aplicación web PHP en docker</h1>
<ul>
<li>
<p>Queremos ejecutar en un contenedor docker la aplicación web escrita en PHP: bookMedik (<a href="https://github.com/evilnapsis/bookmedik)">https://github.com/evilnapsis/bookmedik)</a>.</p>
</li>
<li>
<p>Es necesario tener un contenedor con mariadb donde vamos a crear la base de datos y los datos de la aplicación. El script para generar la base de datos y los registros lo encuentras en el repositorio y se llama schema.sql. Debes crear un usuario con su contraseña en la base de datos. La base de datos se llama bookmedik y se crea al ejecutar el script.</p>
</li>
<li>
<p>Ejecuta el contenedor mariadb y carga los datos del script schema.sql. Para más información.</p>
</li>
<li>
<p>El contenedor mariadb debe tener un volumen para guardar la base de datos.</p>
</li>
<li>
<p>El contenedor que creas debe tener un volumen para guardar los logs de apache2.</p>
</li>
<li>
<p>Crea una imagen docker con la aplicación desde una imagen base de debian o ubuntu. Ten en cuenta que el fichero de configuración de la base de datos (core\controller\Database.php) lo tienes que configurar utilizando las variables de entorno del contenedor mariadb. (Nota: Para obtener las variables de entorno en PHP usar la función getenv. Para más infomación).</p>
</li>
<li>
<p>La imagen la tienes que crear en tu máquina con el comando docker build.</p>
</li>
<li>
<p>Crea un script con docker compose que levante el escenario con los dos contenedores.(Usuario: admin, contraseña: admin).</p>
</li>
</ul>
<h2 id="contenedor-con-mariadb">Contenedor con mariadb</h2>
<p>debemos de irnos al directorio de <strong>Deploy</strong> y debemos de generar un fichero para <strong>docker-compose</strong> para poder desplegar nuestro contenedor mariadb, el contenido de dicho fichero <strong>docker-compose.yml</strong> debe de ser el siguiente:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.1&#34;</span>

<span style="color:#f92672">services</span>:
  <span style="color:#f92672">db</span>:
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">servidor_mysql</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mariadb</span>
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">environment</span>:
      <span style="color:#f92672">MYSQL_DATABASE</span>: <span style="color:#ae81ff">bookmedik</span>
      <span style="color:#f92672">MYSQL_USER</span>: <span style="color:#ae81ff">bookmedik</span>
      <span style="color:#f92672">MYSQL_PASSWORD</span>: <span style="color:#ae81ff">bookmedik</span>
      <span style="color:#f92672">MYSQL_ROOT_PASSWORD</span>: <span style="color:#ae81ff">franciscojavier</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#ae81ff">/opt/mysql_wp:/var/lib/mysql</span>
</code></pre></div><h2 id="generar-imagen-bookmedik">Generar imagen bookmedik</h2>
<p>Una vez hayamos creado la base de datos con nuestro fichero <strong>docker-compose.yml</strong>, debemos de generar una imagen donde tengamos instalado la aplicación <strong>bookmedik</strong> por lo que debemos de generer, en el directorio <strong>Build</strong> un fichero llamado <strong>Dockerfile</strong> en el cual vamos a indicar como se va a generar nuestra imagen y, a su vez, debemos de clonar el repositorio de <a href="https://github.com/evilnapsis/bookmedik">bookmedik</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> debian</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get install -y apache2 libapache2-mod-php7.3 php7.3 php7.3-mysql <span style="color:#f92672">&amp;&amp;</span> apt-get clean <span style="color:#f92672">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> rm /var/www/html/index.html<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> APACHE_SERVER_NAME<span style="color:#f92672">=</span>www.bookmedik-francisco.org<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> DATABASE_USER<span style="color:#f92672">=</span>bookmedik
<span style="color:#66d9ef">ENV</span> DATABASE_PASSWORD<span style="color:#f92672">=</span>bookmedik
<span style="color:#66d9ef">ENV</span> DATABASE_HOST<span style="color:#f92672">=</span>bd

<span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 80</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./bookmedik /var/www/html<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> script.sh /usr/local/bin/script.sh<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x /usr/local/bin/script.sh<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/usr/local/bin/script.sh&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Una vez tengamos este fichero debemos de generar en el mismo directorio de <strong>Build</strong> un fichero llamado <strong>script.sh</strong> en el cual vamos a indicar una serie de pasos que se debe de ejecutar como son la asignación de variables de entorno que necesita:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
sed -i <span style="color:#e6db74">&#39;s/$this-&gt;user=&#34;root&#34;;/$this-&gt;user=&#34;&#39;</span><span style="color:#e6db74">${</span>DATABASE_USER<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;;/g&#39;</span> /var/www/html/core/controller/Database.php
sed -i <span style="color:#e6db74">&#39;s/$this-&gt;pass=&#34;&#34;;/$this-&gt;pass=&#34;&#39;</span><span style="color:#e6db74">${</span>DATABASE_PASSWORD<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;;/g&#39;</span> /var/www/html/core/controller/Database.php
sed -i <span style="color:#e6db74">&#39;s/$this-&gt;host=&#34;localhost&#34;;/$this-&gt;host=&#34;&#39;</span><span style="color:#e6db74">${</span>DATABASE_HOST<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;;/g&#39;</span> /var/www/html/core/controller/Database.php
apache2ctl -D FOREGROUND
</code></pre></div><p>De esta forma estamos cambiando las variables de entorno para que asi pueda reconocer la base de datos que esta en nuestro otro contenedor como la ejecución de apache2. Una vez hecho debemos de generar nuestra nueva imagen a partir del fichero de Dockerfile, para ello debemos de irnos al directorio <strong>Build</strong> y ejecutamos el siguiente comando:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Construimos la imagen ####</span>
francisco@debian10:~/Documentos/Implantacion/Docker/Docker-php/Tarea 1/Build$ docker build -t franjavimn/bookmedik:v1 .

<span style="color:#75715e">#### Vemos la imagen que nos ha creado ####</span>
francisco@debian10:~/Documentos/Implantacion/Docker/Docker-php/Tarea 1/Build$ docker image list
REPOSITORY                    TAG                 IMAGE ID            CREATED             SIZE
franjavimn/bookmedik          v1                  fa389d1f6461        <span style="color:#ae81ff">22</span> minutes ago      251MB
...
</code></pre></div><h2 id="desplegar-docker-compose">Desplegar docker-compose</h2>
<p>Una vez hayamos creado la imagen, vamos a editar neustro fichero de <strong>docker-compose.yml</strong> y le vamos a añadir un nuevo contenedor, en este caso es donde vamos a tener nuestra aplicacion de <strong>bookmedik</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.1&#34;</span>

<span style="color:#f92672">services</span>:
  <span style="color:#f92672">db</span>:
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">servidor_mysql</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mariadb</span>
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">environment</span>:
      <span style="color:#f92672">MYSQL_DATABASE</span>: <span style="color:#ae81ff">bookmedik</span>
      <span style="color:#f92672">MYSQL_USER</span>: <span style="color:#ae81ff">bookmedik</span>
      <span style="color:#f92672">MYSQL_PASSWORD</span>: <span style="color:#ae81ff">bookmedik</span>
      <span style="color:#f92672">MYSQL_ROOT_PASSWORD</span>: <span style="color:#ae81ff">franciscojavier</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#ae81ff">/opt/mysql_bookmedik:/var/lib/mysql</span>

  <span style="color:#f92672">bookmedik</span>:
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">bookmedik</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">franjavimn/bookmedik:v1</span>
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#ae81ff">8082</span>:<span style="color:#ae81ff">80</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#ae81ff">/opt/bookmedik:/var/log/apache2</span>
</code></pre></div><p>Una vez hecho esto, debemos de pasar el script de la creacion de las tablas a nuestro contenedor de mariadb, este fichero esta en el directorio que hemos generado tras clonar el repositorio y su nombre es <strong>schema.sql</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#### Le pasamos el script ####</span>
francisco@debian10:~/Documentos/Implantacion/Docker/Docker-php/Tarea 1/Deploy$ cat ../Build/bookmedik/schema.sql | docker exec -i servidor_mysql /usr/bin/mysql -u root --password<span style="color:#f92672">=</span>franciscojavier bookmedik
</code></pre></div><p>Y ahora, si entramos en <strong>localhost:8082</strong> veremos que nos sale nuestro login el cual es <strong>admin/admin</strong> y debe de salirnos algo como lo siguiente:</p>
<p><img src="https://raw.githubusercontent.com/FranJaviMN/elementos-grado/main/Implantacion/docker/bookmedik.png" alt="imagen bookmedik"></p>

  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  Francisco Javier Martín Núñez 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/sistemas">Sistemas</a></li>
         
        <li><a href="/seguridad">Seguridad</a></li>
         
        <li><a href="/servicios">Servicios</a></li>
         
        <li><a href="/implantacion">Implantacion</a></li>
         
        <li><a href="/bbdd">BBDD</a></li>
         
        <li><a href="/hlc">HLC</a></li>
         
        <li><a href="/cloud">Cloud</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
  
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>
